{% load irpf_tags %}
<div class="card mt-1 mb-2 unsort irpfreport">
  <div class="card-header">
    <button type="button" class="btn btn-link" data-toggle="collapse" data-target="#collapsebody-{{ forloop.counter }}"
            aria-expanded="true" aria-controls="collapsebody-{{ forloop.counter }}">
      {{ asset.code }}{% if asset.enterprise %} - {{ asset.enterprise.name }} ({{ asset.enterprise.cnpj }}){% endif %}
    </button>
    <button type="button" class="btn btn-link" data-toggle="popover"
            data-content="
        {% if asset.enterprise %}
          {{ asset.results.buy.quantity }}
          {% if asset.enterprise.is_fii %}cota{{ asset.results.buy.quantity|pluralize:"s" }}
          {% elif asset.enterprise.is_acao %}ações
          {% elif asset.enterprise.is_bdr %}bdr{{ asset.results.buy.quantity|pluralize:"s" }}
          {% endif %}
          {{ asset.code }} / {{ asset.enterprise.name }} - {{ asset.enterprise.cnpj }} /
          na corretora {{ asset.institution }} /
          a um custo médio de R$ {{ asset.results.buy.avg_price|moneyformat }}
        {% else %}
          {{ asset.code }}
        {% endif %}">
      <i class="fa fa-info-circle"></i>
    </button>

  </div>
  <div id="collapsebody-{{ forloop.counter }}" class="collapse show">
    <div class="card-body">
      <h6 class="card-subtitle mb-2 mt-2 text-primary">Posição atual{% if asset.results.position.date %} ({{ asset.results.position.date }}){% endif %}</h6>
      <p class="card-text">Quantidade: {{ asset.results.position.quantity|default:0 }}</p>
      <p class="card-text">Preço médio: R$ {{ asset.results.position.avg_price|default:0|moneyformat }}</p>
      <p class="card-text">Valor total: R$ {{ asset.results.position.total|default:0|moneyformat }}</p>

    {% if asset.results.sell %}
      <hr/>
      <h6 class="card-subtitle mb-2 text-muted">Vendas do período</h6>
      <p class="card-text">Quantidade de venda: {{ asset.results.sell.quantity }}</p>
      <p class="card-text">Preço médio de venda: R$ {{ asset.results.sell.avg_price|moneyformat }}</p>
      <p class="card-text">Valor total de venda: R$ {{ asset.results.sell.total|moneyformat }}</p>
      <p class="card-text">Ganho de capital: R$ {{ asset.results.sell.capital|moneyformat }}</p>
    {% endif %}

      <hr/>
      <h6 class="card-subtitle mb-2 text-success">Posição do período</h6>
      <p class="card-text">Quantidade líquida: {{ asset.results.buy.quantity }}</p>
      <p class="card-text">Preço médio de compra: R$ {{ asset.results.buy.avg_price|moneyformat }}</p>
      <p class="card-text">Valor total de compra: R$ {{ asset.results.buy.total|moneyformat }}</p>

    {% if asset.earnings %}
      <hr/>
      <h6 class="card-subtitle mb-2 text-info">Proventos e bonificações</h6>
      {% if asset.earnings.dividendo %}
        <p class="card-text">{{ asset.earnings.dividendo.title }}:
          <span>R$ {{ asset.earnings.dividendo.value|moneyformat }}</span>
        </p>
      {% endif %}
      {% if asset.earnings.juros_sobre_capital_proprio %}
        <p class="card-text">{{ asset.earnings.juros_sobre_capital_proprio.title }}:
          <span>R$ {{ asset.earnings.juros_sobre_capital_proprio.value|moneyformat }}</span>
        </p>
      {% endif %}
      {% if asset.earnings.bonificacao_em_ativos %}
        <p class="card-text">{{ asset.earnings.bonificacao_em_ativos.title }}</p>
        <p class="card-text">
          Quantidade: {{ asset.earnings.bonificacao_em_ativos.quantity|moneyformat }},
          valor: R$ {{ asset.earnings.bonificacao_em_ativos.value|moneyformat }}
        </p>
      {% endif %}
      {% if asset.earnings.rendimento %}
        <p class="card-text">{{ asset.earnings.rendimento.title }} (cumulativo):
          <span>R$ {{ asset.earnings.rendimento.value|moneyformat }}</span>
        </p>
      {% endif %}
      {% exclude_obj_keys asset.earnings "dividendo" "juros_sobre_capital_proprio" "bonificacao_em_ativos" "rendimento" as item_others %}
      {% if item_others %}
        <hr/>
        <h6 class="card-subtitle mb-2 text-info">Outros ganhos</h6>
        {% for key, item_val in item_others.items %}
          <p class="card-text">{% get_obj_val item_val "title" %}:
            <span>Quantidade {% get_obj_val item_val "quantity" %}</span>,
            <span>R$ {% get_obj_val item_val "value" %}</span>
          </p>
        {% endfor %}
      {% endif %}
    {% endif %}
      {% if asset.enterprise and asset.enterprise.bookkeeping %}
        <hr/>
        <h6 class="card-subtitle mb-2 text-info">Escriturador:
        <a href="{{ asset.enterprise.bookkeeping.link }}" target="_blank">{{ asset.enterprise.bookkeeping.name }}</a>
        </h6>
      {% endif %}
    </div>
  </div>
</div>